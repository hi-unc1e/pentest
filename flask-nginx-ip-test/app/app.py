from flask import Flask, request

app = Flask(__name__)

@app.route('/getip')
def get_ip():
    # 优先使用REMOTE_ADDR，其次使用X-Forwarded-For的第一个值
    client_ip = request.environ.get('HTTP_X_FORWARDED_FOR')
    if client_ip:
        # 分割并获取第一个IP地址
        client_ip = client_ip.split(',')[0].strip()
    else:
        client_ip = request.environ.get('REMOTE_ADDR')

    x_forwarded_for = request.headers.getlist("X-Forwarded-For")
    print(f"x_forwarded_for_list={x_forwarded_for}")
    all_ips = ', '.join(x_forwarded_for)

    print(f"First IP: {client_ip}")
    print(f"All IPs: {all_ips}")

    return f"First IP: {client_ip}<br>All IPs: {all_ips}"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)